Deploy to Linux using Docker - for use with .Net 7.0
----------------------------------------------------------------------------------------

1. Create a new droplet with Digital Ocean using the Docker 20.x.x image on Ubuntu 20.04

    IP address: Your IP Address
    Password for root user: Your password


2. Login to the droplet using either the terminal or Powershell:

    ssh root@ipaddress

    You will be asked for your password.   Enter this.


3.  Create a new docker-compose file using the following command:

    sudo nano docker-compose.yml


4.  Copy and paste in the docker-compose configuration:

    services:
      redis:
        image: redis:latest
        ports:
          - 6379:6379
        command: ["redis-server", "--appendonly", "yes"]
        volumes:
          - redis-data:/data
      redis-commander:
        image: rediscommander/redis-commander:latest
        environment:
          - REDIS_HOSTS=local:redis:6379
          - HTTP_USER=root
          - HTTP_PASSWORD=secret
        ports:
          - 8081:8081
        depends_on:
          - redis
      db:
        image: postgres
        restart: always
        environment:
          POSTGRES_PASSWORD: secret
          POSTGRES_USER: appuser
        ports:
          - 5432:5432
        volumes:
          - postgres-data:/data
    volumes:
      redis-data:
      postgres-data:


5.  Run the following command to start the docker services

    docker-compose up -d

    *** Note: if you get a warning telling you that docker-compose is unavailable then just use:

    apt install docker-compose

    Then re-run the docker-compose up command


6.  Install and configure apache by running the following commands:

    apt update
    apt install apache2
    a2enmod proxy proxy_http proxy_html rewrite
    systemctl restart apache2
    ufw app list
    ufw allow 'Apache Full'
    systemctl status apache2


7.   Optional - allow the ports through the firewall to allow you to manage PostGreSQL and Redis via the ports.

    ufw allow 5432/tcp
    ufw allow 8081/tcp


8.  Test you can access the default apache page by browsing to:  http://Your IP Address


9.  Create a new directory that will contain our published dotnet app and assign rights to the user:

    mkdir /var/guitars-eshop
    chown -R $USER:$USER /var/guitars-eshop


10.  Create a new config file for the guitars-eshop app:

    nano /etc/apache2/sites-available/guitars-eshop.conf


11.  Paste in the following configuration which will set up a reverse proxy with the Kestrel server:

    <VirtualHost *:80>
        ServerAdmin webmaster@localhost
        ProxyPreserveHost On
        ProxyPass / http://127.0.0.1:5000/
        ProxyPassReverse / http://127.0.0.1:5000
        ErrorLog ${APACHE_LOG_DIR}/error.log
        CustomLog ${APACHE_LOG_DIR}/access.log combined
    </VirtualHost>


12.  Enable the guitars-eshop site by running the following commands:

    a2ensite guitars-eshop
    ls /etc/apache2/sites-enabled
    a2dissite 000-default
    systemctl reload apache2


13.  Install the deploy reloaded extension.
    Create a settings.json file in the .vscode directory and update the IP address and password for your server:

    {
      "deploy.reloaded": {
          "packages": [
              {
                  "name": "Version 1.0.0",
                  "description": "Package version 1.0.0",
                  "files": [
                      "publish/**"
                  ]
              }
          ],
          "targets": [
              {
                  "type": "sftp",
                  "name": "Linux",
                  "description": "SFTP folder",
                  "host": "ipaddress", "port": 22,
                  "user": "root", "password": "your password",
                  "dir": "/var/guitars-eshop",
                  "mappings": {
                      "publish/**": "/"
                  }
              }
          ]
      }
  }


14.  Optional -
    Change the logging level for the appsettings.json to information for the Microsoft logging level:

    {
      "Logging": {
        "LogLevel": {
          "Default": "Information",
          "Microsoft": "Information",
          "Microsoft.Hosting.Lifetime": "Information"
        }
      },
    }

15.  Republish the app with changes by running the following command in VS Code terminal:

    dotnet publish -c Release -o publish eshop-dotnet-angular.sln


16.  Deploy the files by using the command pallette -> deploy reloaded -> deploy package


17.  Add an endpoint to stripe for to point to the IP address of the server and
    select the 2 events we want to listen to:
    payment_intent.succeeded, payment_intent.payment_failed.
    Note the web hook secret as we will need this soon.

    http://165.227.163.19/api/payments/webhook


18.  Back on the linux server create a service config for the kestrel server:

    nano /etc/systemd/system/guitars-eshop-web.service


19.  Update the configuration for your API keys where it says REPLACEME
    and then paste the config into the nano editor

    [Unit]
    Description=Kestrel service running on Ubuntu 20.04
    [Service]
    WorkingDirectory=/var/guitars-eshop
    ExecStart=/usr/bin/dotnet /var/guitars-eshop/API.dll
    Restart=always
    RestartSec=10
    SyslogIdentifier=guitars-eshop
    User=www-data
    Environment=ASPNETCORE_ENVIRONMENT=Production
    Environment='Token__Key=CHANGE ME TO SOMETHING SECURE'
    Environment='Token__Issuer=http://165.227.163.19'
    Environment='StripeSettings__PublishibleKey=pk_test_51HzgaFIXr1p1PxRJ0T0QFXlOjX7gTpjLEVANQZXnw6wk6ef22MscGIf6ZtaKWggh6CP5w2FGC6BilQ4mD1h97Glp00Zy3OswVT'
    Environment='StripeSettings__SecretKey=sk_test_51HzgaFIXr1p1PxRJgGCuuNkeLtM4y9PcUcGaK3694zr3NkLUoDFF9ZE1btLUYf1kt8wPh0hbSjCKfmcLiUHoDxan00Xv35KSmm'
    Environment='StripeSettings__WhSecret=whsec_Iz2CUDCxTwFcyvrlUOLZJybFSBqvGtVX'
    Environment='ConnectionStrings__DefaultConnection=Server=localhost;Port=5432;User Id=appuser;Password=secret; Database=store'
    Environment='ConnectionStrings__IdentityConnection=Server=localhost;Port=5432;User Id=appuser;Password=secret; Database=identity'
    Environment='ConnectionStrings__Redis=localhost'
    Environment='ApiUrl=http://165.227.163.19/Content/'
    [Install]
    WantedBy=multi-user.target


20.  Install the .Net runtime using the instructions here:
    https://docs.microsoft.com/en-gb/dotnet/core/install/linux-ubuntu#2004-

    Τρέχουμε 2 κομμάτια με εντολές:

    1.----------------------------------------------------------------------
    # Get Ubuntu version
    declare repo_version=$(if command -v lsb_release &> /dev/null; then lsb_release -r -s; else grep -oP '(?<=^VERSION_ID=).+' /etc/os-release | tr -d '"'; fi)

    # Download Microsoft signing key and repository
    wget https://packages.microsoft.com/config/ubuntu/$repo_version/packages-microsoft-prod.deb -O packages-microsoft-prod.deb

    # Install Microsoft signing key and repository
    dpkg -i packages-microsoft-prod.deb

    # Clean up
    rm packages-microsoft-prod.deb

    # Update packages
    apt update

    2.--------------------------------------------------------------------------

    apt-get update && \
    apt-get install -y aspnetcore-runtime-7.0


21.  Restart the journal service by running the following command:

    systemctl restart systemd-journald


22.  Start the kestrel service by running the following command:

    systemctl start guitars-eshop-web.service


23.  Check it is started by running:

    netstat -ntpl


24.  Check the journal by running:

    journalctl -u guitars-eshop-web.service --since "5 min ago"


25.  Make sure there are no errors and then test you can browse to the published app on http://ipaddress



